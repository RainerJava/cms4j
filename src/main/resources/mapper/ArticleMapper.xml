<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Article">

    <!--
         获取文章数量
     -->
    <select id="getArticleCount" parameterType="Long" resultType="Long">
        select count(id)
        from cms_article
        where id in (select article_id from cms_category_article where category_id=#{categoryId}) and status=1 and deleted=0
        limit 1
	</select>

    <!--
         获取已标记为删除的文章id
     -->
    <select id="getDeletedArticleId" resultType="Long">
        select id
        from cms_article
        where deleted=1
        order by id ASC
        limit 500
	</select>

    <!--
         获取文章正文
     -->
    <select id="getArticle" parameterType="int" resultType="Article">
        select id,subject,message,digest,keyword,author,category_name as categoryname,rate,rate_times as ratetimes,top,status,allow_comment as allowcomment,views,cms_article.created_date as createddate,cms_article.last_modified_date as lastmodifieddate
        from cms_article
        where id=#{id}
        limit 1
	</select>

    <!--
         获取所有文章where deleted=0
     -->
    <select id="getAllArticle" parameterType="map" resultType="Article">
        select id,subject,author,category_name as categoryname,rate,rate_times as ratetimes,views,top,allow_comment as allowcomment,status,deleted,cms_article.created_date as createddate,cms_article.last_modified_date as lastmodifieddate
        from cms_article
        order by ${Sort} ${Direction}
	</select>

    <!--
        获取本月的所有文章
    -->
    <select id="getMonthArticle" parameterType="Date" resultType="Article">
        select id,subject,author,category_name as categoryname,rate,rate_times as ratetimes,views,top,status,deleted,cms_article.created_date as createddate,cms_article.last_modified_date as lastmodifieddate
        from cms_article
        where deleted=0 and year(created_date)=year(#{created_date}) and month(created_date)=month(#{created_date})
        order by id desc
	</select>

    <!--
        获取top 10 文章
    -->
    <select id="getTopTenArticle" resultType="Article">
        select id,subject,author,category_name as categoryname,rate,rate_times as ratetimes,views,top,status,deleted,cms_article.created_date as createddate,cms_article.last_modified_date as lastmodifieddate
        from cms_article
        where deleted=0
        order by id desc
        limit 0,10
    </select>

    <!--
        获取首页新闻资讯
    -->
    <select id="getNews" resultType="Article">
        select id,subject,image_name as imagename,digest,category_name as categorynamedeleted
        from cms_article
        where id in (select article_id from cms_category_article where category_id=3 or category_id=5) and deleted=0
        order by id desc
        limit 0,5
    </select>

    <!--
         通过分类id获取文章
     -->
    <select id="getArticleListByCategoryId" parameterType="int" resultType="Article">
        select id,subject,author,category_name as categoryname,rate,rate_times as ratetimes,top,status,allow_comment as allowcomment,views,created_date as createddate,last_modified_date as lastmodifieddate
        from cms_article
        where id in (select article_id from cms_category_article where category_id=#{categoryId}) and status=1 and deleted=0
        order by top desc
	</select>

    <!--
         通过分类id获取文章
     -->
    <select id="getArticleDigestByCategoryId" parameterType="int" resultType="Article">
        select id,subject,digest,author,category_name as categoryname,rate,rate_times as ratetimes,views,created_date as createddate,last_modified_date as lastmodifieddate,top,status
        from cms_article
        where id in (select article_id from cms_category_article where category_id=#{categoryId}) and status=1 and deleted=0
        order by top desc
	</select>

    <!--
         查询文章
     -->
    <select id="searchArticle" parameterType="map" resultType="Article">
        select id,subject,message,digest,author,category_name as categoryname,rate,rate_times as ratetimes,views,created_date as createddate,last_modified_date as lastmodifieddate,top,status
        from cms_article
        <where>
            <if test="author != null">
                author=#{author}
            </if>
            <if test="top != null">
                and top=#{top}
            </if>
            <if test="status != null">
                and status=#{status}
            </if>
            <if test="keyword != null">
                and keyword=#{keyword}
            </if>
            <if test="deleted != null">
                and deleted=#{deleted}
            </if>
        </where>
        order by ${Sort} ${Direction}
        limit 500
    </select>

    <!-- 更新文章 -->
    <update id="updateArticle" parameterType="Article">
        update cms_article
        set author=#{author},category_name=#{categoryName},subject=#{subject},message=#{message},digest=#{digest},
        keyword=#{keyword},top=#{top},status=#{status},rate=#{rate},rate_times=#{rateTimes},deleted=#{deleted},
        allow_comment=#{allowComment},last_modified_date = now()
        where id = #{id}
	</update>

    <!-- 删除文章 -->
    <delete id="delete">
        delete from cms_article
        where deleted = 1
        limit 500
	</delete>
</mapper>